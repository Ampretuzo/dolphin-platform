<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/raphael/raphael.js"></script>
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_graffle.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_graph.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_algorithms.js"></script>

<polymer-element name="workflow-canvas" attributes="data">
    <template>
        <div id="flowchart"></div>
    </template>
    <script>
        Polymer({
            dataChanged: function(oldValue, newValue) {
                console.log("processInstance changed", newValue);

                var host = this.$.flowchart;
                if (typeof host.firstChild !== 'undefined' && host.firstChild !== null) {
                    host.removeChild(host.firstChild);
                }

                var width = host.offsetWidth;
                var height = 1000;


                var startEventRenderer = function(r, n) {
                    return r.set()
                            .push(r.circle(0, 0, 20).attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.text(0, 30, n.label).attr({'font-size': 15}));
                };

                var endEventRenderer = function(r, n) {
                    return r.set()
                            .push(r.circle(0, 0, 20)).attr({'stroke-width': 5, 'fill': '#fff'})
                            .push(r.text(0, 30, n.label).attr({'font-size': 15}));
                };

                var exclusiveGatewayRenderer = function(r, n) {
                    return r.set()
                            .push(r.path('M30,0L0,30L-30,0,L0,-30,Z').attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.path('M10,15,L-10,-15M10,-15,L-10,15').attr({'stroke-width': 5}))
                            .push(r.text(0, 40, n.label).attr({'font-size': 15}));
                };

                var taskRenderer = function(r, n) {
                    return r.set()
                            .push(r.rect(-75, -50, 150, 100, 10).attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.text(0, 0, n.label).attr({'font-size': 15}));
                };

                var g = new Graph();

                newValue.activities.forEach(function(activity) {
                    /*
                    activityName, activityId, description, type
                    */
                    var label = typeof activity.activityName === 'undefined' || activity.activityName === null? ' ' : activity.activityName;

                    var renderer;
                    switch (activity.type) {
                        case 'startEvent':
                            renderer = startEventRenderer;
                            break;
                        case 'endEvent':
                            renderer = endEventRenderer;
                            break;
                        case 'exclusiveGateway':
                            renderer = exclusiveGatewayRenderer;
                            break;
                        case 'userTask':
                        case 'serviceTask':
                        case 'subProcess':
                            renderer = taskRenderer;
                            break;
                    }

                    g.addNode(activity.activityId, {label: label, render: renderer});
                });
                newValue.activities.forEach(function(activity) {
                    if (typeof activity.outgoingTransitions !== 'undefined' && activity.outgoingTransitions !== null) {
                        activity.outgoingTransitions.forEach(function (transition) {
                            /*
                             transitionName, activityId, description, conditionText
                             */
                            var label = typeof transition.transitionName === 'undefined' || transition.transitionName === null? '' : transition.transitionName;
                            var sublabel = typeof transition.conditionText === 'undefined' || transition.conditionText === null? '' : transition.conditionText;
                            var target = transition.target;
                            g.addEdge(activity.activityId, target.activityId, {directed : true, label: label + ' ' + sublabel});
                        });
                    }
                });

                /* layout the graph using the Spring layout implementation */
                var layouter = new Graph.Layout.Spring(g);

                /* draw the graph using the RaphaelJS draw implementation */
                var renderer = new Graph.Renderer.Raphael(host, g, width, height);

                redraw = function() {
                    layouter.layout();
                    renderer.draw();
                };
                hide = function(id) {
                    g.nodes[id].hide();
                };
                show = function(id) {
                    g.nodes[id].show();
                };
                //    console.log(g.nodes["kiwi"]);
                //redraw();

            }
        })
    </script>
</polymer-element>