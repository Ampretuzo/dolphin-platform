<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/raphael/raphael.js"></script>
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_graffle.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_graph.js"></script>
<script src="../bower_components/graphdracula/lib/dracula_algorithms.js"></script>

<polymer-element name="workflow-canvas" attributes="data">
    <template>
        <div id="flowchart"></div>
    </template>
    <script>
        Polymer({
            dataChanged: function(oldValue, newValue) {
                console.log("processInstance changed", newValue);

                var host = this.$.flowchart;
                if (typeof host.firstChild !== 'undefined' && host.firstChild !== null) {
                    host.removeChild(host.firstChild);
                }

                var width = Math.max(1200, host.offsetWidth);
                var height = Math.max(1000, host.offsetHeight);


                var startEventRenderer = function(r, n) {
                    return r.set()
                            .push(r.circle(0, 0, 20).attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.text(0, 30, n.label).attr({'font-size': 15}));
                };

                var endEventRenderer = function(r, n) {
                    return r.set()
                            .push(r.circle(0, 0, 20)).attr({'stroke-width': 5, 'fill': '#fff'})
                            .push(r.text(0, 30, n.label).attr({'font-size': 15}));
                };

                var exclusiveGatewayRenderer = function(r, n) {
                    return r.set()
                            .push(r.path('M30,0L0,30L-30,0,L0,-30,Z').attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.path('M10,15,L-10,-15M10,-15,L-10,15').attr({'stroke-width': 5}))
                            .push(r.text(0, 40, n.label).attr({'font-size': 15}));
                };

                var taskRenderer = function(r, n) {
                    return r.set()
                            .push(r.rect(-75, -50, 150, 100, 10).attr({'stroke-width': 2, 'fill': '#fff'}))
                            .push(r.text(0, 0, n.label).attr({'font-size': 15}));
                };

                var userTaskRenderer = function(r, n) {
                    var renderer = taskRenderer(r, n);
                    renderer.push(
                            r.path('M28.523,23.813c-0.518-0.51-6.795-2.938-7.934-3.396c-1.132-0.451-1.584-1.697-1.584-1.697s-0.51,0.282-0.51-0.51c0-0.793,0.51,0.51,1.021-2.548c0,0,1.414-0.397,1.133-3.68l-0.338,0.001c0,0,0.85-3.511,0-4.699c-0.854-1.188-1.188-1.981-3.062-2.548c-1.869-0.567-1.188-0.454-2.547-0.396c-1.359,0.057-2.492,0.793-2.492,1.188c0,0-0.849,0.057-1.188,0.397c-0.34,0.34-0.906,1.924-0.906,2.32s0.283,3.059,0.566,3.624l-0.337,0.112c-0.283,3.283,1.132,3.681,1.132,3.681c0.509,3.058,1.019,1.755,1.019,2.548c0,0.792-0.51,0.51-0.51,0.51s-0.452,1.246-1.584,1.697c-1.132,0.453-7.416,2.887-7.927,3.396c-0.511,0.521-0.453,2.896-0.453,2.896h26.954C28.977,26.709,29.039,24.332,28.523,23.813zM16.618,13.693c-0.398-0.251-0.783-1.211-0.783-1.64c0-0.133,0-0.236,0-0.236c-0.105-0.106-0.574-0.096-0.67,0c0,0,0,0.104,0,0.236c0,0.429-0.385,1.389-0.783,1.64c-0.399,0.251-1.611,0.237-2.084-0.236c-0.473-0.473-0.524-1.663-0.643-1.78c-0.118-0.119-0.185-0.185-0.185-0.185l0.029-0.414c0,0,0.842-0.207,1.699-0.207s1.803,0.502,1.803,0.502c0.231-0.074,0.784-0.083,0.996,0c0,0,0.945-0.502,1.803-0.502s1.699,0.207,1.699,0.207l0.029,0.414c0,0-0.066,0.066-0.185,0.185c-0.118,0.118-0.169,1.308-0.643,1.78C18.229,13.93,17.018,13.944,16.618,13.693z')
                                    .transform('t40,-50')
                                    .attr({'fill': '#000'})
                    );
                    return renderer;
                };

                var serviceTaskRenderer = function(r, n) {
                    var renderer = taskRenderer(r, n);
                    renderer.push(
                            r.path('M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z')
                                    .transform('T40,-45')
                                    .attr({'fill': '#000'})
                    );
                    return renderer;
                };

                var subProcessTaskRenderer = function(r, n) {
                    var renderer = taskRenderer(r, n);
                    renderer.push(
                            r.path('M6.812,17.202l7.396-3.665v-2.164h-0.834c-0.414,0-0.808-0.084-1.167-0.237v1.159l-7.396,3.667v2.912h2V17.202zM26.561,18.875v-2.913l-7.396-3.666v-1.158c-0.358,0.152-0.753,0.236-1.166,0.236h-0.832l-0.001,2.164l7.396,3.666v1.672H26.561zM16.688,18.875v-7.501h-2v7.501H16.688zM27.875,19.875H23.25c-1.104,0-2,0.896-2,2V26.5c0,1.104,0.896,2,2,2h4.625c1.104,0,2-0.896,2-2v-4.625C29.875,20.771,28.979,19.875,27.875,19.875zM8.125,19.875H3.5c-1.104,0-2,0.896-2,2V26.5c0,1.104,0.896,2,2,2h4.625c1.104,0,2-0.896,2-2v-4.625C10.125,20.771,9.229,19.875,8.125,19.875zM13.375,10.375H18c1.104,0,2-0.896,2-2V3.75c0-1.104-0.896-2-2-2h-4.625c-1.104,0-2,0.896-2,2v4.625C11.375,9.479,12.271,10.375,13.375,10.375zM18,19.875h-4.625c-1.104,0-2,0.896-2,2V26.5c0,1.104,0.896,2,2,2H18c1.104,0,2-0.896,2-2v-4.625C20,20.771,19.104,19.875,18,19.875z')
                                    .transform('T40,-45')
                                    .attr({'fill': '#000'})
                    );
                    return renderer;
                };

                var g = new Graph();

                newValue.activities.forEach(function(activity) {
                    /*
                    activityName, activityId, description, type
                    */
                    var label = typeof activity.activityName === 'undefined' || activity.activityName === null? ' ' : activity.activityName;

                    var renderer;
                    switch (activity.type) {
                        case 'startEvent':
                            renderer = startEventRenderer;
                            break;
                        case 'endEvent':
                            renderer = endEventRenderer;
                            break;
                        case 'exclusiveGateway':
                            renderer = exclusiveGatewayRenderer;
                            break;
                        case 'userTask':
                            renderer = userTaskRenderer;
                            break;
                        case 'serviceTask':
                            renderer = serviceTaskRenderer;
                            break;
                        case 'subProcess':
                            renderer = subProcessTaskRenderer;
                            break;
                    }

                    g.addNode(activity.activityId, {label: label, render: renderer});
                });
                newValue.activities.forEach(function(activity) {
                    if (typeof activity.outgoingTransitions !== 'undefined' && activity.outgoingTransitions !== null) {
                        activity.outgoingTransitions.forEach(function (transition) {
                            /*
                             transitionName, activityId, description, conditionText
                             */
                            var label = typeof transition.transitionName === 'undefined' || transition.transitionName === null? '' : transition.transitionName;
                            var sublabel = typeof transition.conditionText === 'undefined' || transition.conditionText === null? '' : transition.conditionText;
                            var target = transition.target;
                            g.addEdge(activity.activityId, target.activityId, {directed: true, label: label + ' ' + sublabel, fill: '#000|2'});
                        });
                    }
                });

                /* layout the graph using the Spring layout implementation */
                var layouter = new Graph.Layout.Spring(g);

                /* draw the graph using the RaphaelJS draw implementation */
                var renderer = new Graph.Renderer.Raphael(host, g, width, height);

                redraw = function() {
                    layouter.layout();
                    renderer.draw();
                };
                hide = function(id) {
                    g.nodes[id].hide();
                };
                show = function(id) {
                    g.nodes[id].show();
                };
                //    console.log(g.nodes["kiwi"]);
                //redraw();

            }
        })
    </script>
</polymer-element>